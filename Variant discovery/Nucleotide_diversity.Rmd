---
title: "Nucleotide diversity"
author: "Rebecca Batstone"
date: "`r format(Sys.Date())`"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load packages

```{r Load packages, message=FALSE, warning=FALSE}
library(tidyverse)
```

## Calculating nucelotide diversity

Tia provided python script, used in Harrison et al. 2017 (Evolution)
Script available at Dryad, https://doi.org/10.5061/dryad.77k64 (doi:10.5061/dryad.77k64)

copied (cp) KH35c_align.filtered.recode.vcf to python_scripts, and renamed to KH35c_WSM1022.vcf
nohup python diversity2.py KH35c_WSM1022.vcf > nuc_div.out &
Notes: 
- to get samples names in correct format, used excel, then vimmed into python script
- Need to change vcf file in the script

Need to get count of total SNPs in each component (chromosome, plasA, plasB)
Divide average no. of differences by total 

Used this to extract info for each region:
grep '^REGION' file > new_file
Type	Name	      RefSeq	      INSDC
Chr	  -	          NZ_CP021825.1	CP021825.1
Plsm	accessoryA	NZ_CP021826.1	CP021826.1
Plsm	psymA	      NZ_CP021827.1	CP021827.1
Plsm	psymB	      NZ_CP021828.1	CP021828.1

Notes: use actual INSDC accession numbers from NCBI (Chromosome isn't in the code)

scp'ed to my comp:
scp rebecca.batstone@grandiflora.eeb.utoronto.ca:/gran1/rebecca.batstone/python_scripts/nuc_div_Em1022.zip ./mnt/c/Users/rtbatstone/Downloads/

## Import results

```{r data_files}
# full dataset
nuc_div_chrom <- read_csv("./Nucleotide_diversity_files/nuc_div_chrom.csv")
nuc_div_pSymA <- read_csv("./Nucleotide_diversity_files/nuc_div_pSymA.csv")
nuc_div_pSymB <- read_csv("./Nucleotide_diversity_files/nuc_div_pSymB.csv")

nuc_div <- rbind(nuc_div_chrom, nuc_div_pSymA, nuc_div_pSymB)

# calculate nucleotide differences
# We averaged all pairwise nucleotide differences across strains to
# obtain Ï€, and divided it by the number of loci (variant and nonvariant)
# called by GATK to obtain per site values.

# rename genome regions
nuc_div$region <- recode_factor(nuc_div$chrom, 'CP021825.1'="Chromosome", 'CP021827.1'="pSymA", 'CP021828.1'="pSymB")

# add in total sites (both variant and invariant)
nuc_div$tot_sites <- ifelse(nuc_div$region == "Chromosome", 3667614, ifelse(nuc_div$region == "pSymA", 1279311, 1623934))
nuc_div$tot_sites <- as.numeric(nuc_div$tot_sites)

# calculate per site nuc div
nuc_div$nuc_diff <- (nuc_div$pairwise_geno)/(nuc_div$tot_sites)
nuc_div$nuc_diff.t <- (nuc_div$nuc_diff)*10000

# load isolate info file
iso_info <- read_csv("./Nucleotide_diversity_files/isolate_info_KH35c.csv", 
    col_types = cols(line_origin = col_factor(levels = c("anc1022", 
        "270", "276", "279", "313", "267")), 
        morph = col_factor(levels = c("EPS-", 
            "EPS+")),
        state = col_factor(levels = c("anc", "der"))))

# include population defs (state) in diversity dataset
nuc_div$state1 <- iso_info$state[match(nuc_div$samp1,iso_info$vcf_names)]
nuc_div$state2 <- iso_info$state[match(nuc_div$samp2,iso_info$vcf_names)]

# concatenate pops to get comp_type
nuc_div$state_comp <- do.call(paste, c(nuc_div[c("state1","state2")], sep = "vs"))

# include host_env in nuc_div dataset
nuc_div$host1 <- iso_info$line_origin[match(nuc_div$samp1,iso_info$vcf_names)]
nuc_div$host2 <- iso_info$line_origin[match(nuc_div$samp2,iso_info$vcf_names)]

# concatenate hosts to get host_comp_type
nuc_div$host_comp <- do.call(paste, c(nuc_div[c("host1","host2")], sep = "vs"))
```

## Compare pw nucleotide diffs between ancestral and derived isolates

```{r graph_state}
div_sum_state <- nuc_div %>%
  group_by(region, state_comp) %>%
  summarise(mean_div = mean(nuc_diff.t), SE_div = (sd(nuc_diff.t)/sqrt(length(nuc_diff.t))),
            mean_pw = mean(pairwise_geno))
  
div_sum_state$state_comp <- recode_factor(div_sum_state$state_comp,'ancvsanc'="Ancestral",'dervsder'="Derived")

png(filename="./Nucleotide_diversity_files/nuc_div_state.png", units="px", width=863, height=235)

(plot <- ggplot(data=div_sum_state %>% filter(state_comp %in% c("Ancestral","Derived")),
                 aes(x=state_comp, y=mean_div, colour=state_comp)) + 
  geom_point(size=4, position = position_dodge(0.3), colour="black") + 
  geom_errorbar(aes(ymin=mean_div-SE_div, ymax=mean_div+SE_div), width=.1, 
                position = position_dodge(0.3), colour="black") +
  theme_bw() +
  xlab("Evolutionary state") + 
  ylab(expression(paste(pi, " (per 10kbps)"))) +
  facet_wrap(~region, scales="free") +
  scale_colour_discrete(name="Evolutionary state") +
  theme(axis.title.y = element_text(colour = "black", size = 18), 
        axis.text.y = element_text(size=16), 
        axis.title.x = element_blank(), 
        legend.title = element_text(colour="black", size=16, face="bold"),
        legend.text = element_text(colour="black", size=12),
        axis.text.x = element_text(size=16),
        legend.position="none",
        strip.text = element_text(size=12, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()))

dev.off()
```

## Compare pw nucleotide diffs between ancestral and isolates evolving on ea. plant line

```{r graph_hosts}
div_sum_host <- nuc_div %>%
  group_by(region, host_comp) %>%
  summarise(mean_div = mean(nuc_diff.t), SE_div = (sd(nuc_diff.t)/sqrt(length(nuc_diff.t))),
            mean_pw = mean(pairwise_geno))
  
div_sum_host$host_comp <- recode_factor(div_sum_host$host_comp,'anc1022vsanc1022'="Ancestral",
                                        '270vs270'="270", '276vs276'="276", '279vs279'="279",
                                        '313vs313'="313", '267vs267'="267")

png(filename="./Nucleotide_diversity_files/nuc_div_host.png", units="px", width=945, height=275)

(plot <- ggplot(data=div_sum_host %>% filter(host_comp %in% c("270","276","279","313","267")),
                 aes(x=host_comp, y=mean_div, colour=host_comp)) + 
  geom_point(size=4, position = position_dodge(0.3), colour="black") + 
  geom_errorbar(aes(ymin=mean_div-SE_div, ymax=mean_div+SE_div), width=.1, 
                position = position_dodge(0.3), colour="black") +
  geom_hline(data=div_sum_host %>% filter(host_comp == "Ancestral"),
                                          aes(yintercept = mean_div), linetype = 2, color = "black") +
  theme_bw() +
  xlab("Evolutionary host") + 
  ylab(expression(paste(pi, " (per 10kbps)"))) +
  facet_wrap(~region, scales="free") +
  scale_colour_discrete(name="Evolutionary host") +
  theme(axis.title.y = element_text(colour = "black", size = 18), 
        axis.text.y = element_text(size=16), 
        axis.title.x = element_blank(), 
        legend.title = element_text(colour="black", size=16, face="bold"),
        legend.text = element_text(colour="black", size=12),
        axis.text.x = element_text(size=16),
        legend.position="none",
        strip.text = element_text(size=12, face = "bold"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()))

dev.off()
```
